<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.7.4 at 2019-01-09 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Gert Dewit" />
    <meta name="Date-Creation-yyyymmdd" content="20180624" />
    <meta name="Date-Revision-yyyymmdd" content="20190109" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Linux Packaging Maven Plugin &#x2013; Debian example</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
      <script type="text/javascript" src="./js/apache-maven-fluido-1.6.min.js"></script>
      </head>
    <body class="topBarDisabled">
      <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>Linux Packaging Maven Plugin</h2>
</div>
</div>
        <div class="pull-right"></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2019-01-09<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 1.2.1</li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
          <li class="nav-header">Overview</li>
    <li><a href="index.html" title="Introduction"><span class="none"></span>Introduction</a>  </li>
    <li><a href="plugin-info.html" title="Goals"><span class="none"></span>Goals</a>  </li>
    <li><a href="usage.html" title="Usage"><span class="none"></span>Usage</a>  </li>
    <li><a href="faq.html" title="FAQ"><span class="none"></span>FAQ</a>  </li>
    <li><a href="http://www.gnu.org/licenses/agpl-3.0.html" class="externalLink" title="License"><span class="none"></span>License</a>  </li>
          <li class="nav-header">Examples</li>
    <li class="active"><a href="#"><span class="none"></span>Debian example</a>
  </li>
          <li class="nav-header">Project Documentation</li>
    <li><a href="project-info.html" title="Project Information"><span class="none"></span>Project Information</a>  </li>
    <li><a href="project-reports.html" title="Project Reports"><span class="none"></span>Project Reports</a>  </li>
  </ul>
          <hr />
          <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<div class="section">
<h2><a name="Debian_example"></a>Debian example</h2>
<p>The example describes a module that packages a Spring Boot web application that is started at boot time using <a class="externalLink" href="https://www.freedesktop.org/wiki/Software/systemd/">systemd</a> and has a config directory in /etc.</p>
<p>The app needs to run as a non privileged user which is created using a preinstall script.</p>
<p>The non priviledged user should be granted the privilege to write to the application log folder.</p>
<div class="section">
<h3><a name="Folder_structure"></a>Folder structure</h3>
<div class="source"><pre class="prettyprint">  pom.xml
  +--- src/main/resources/deb/
      +--- DEBIAN/
      |   +--- preinst
      +--- etc/hiapp/
      |   +--- hiapp.properties
      +--- lib/systemd/system
          +--- hiapp.service</pre></div>
<p>The <tt>src/main/resources/deb</tt> folder is the starting point for the file system resources. The DEBIAN subfolder contains the Debian control files, in this example only <b>preinst</b> is used, other possible files are <b>postinst</b>, <b>prerm</b>, <b>postrm</b>, ...</p>
<p>The other folders and files are considered to be data files, in this example the systemd script hiapp.service and it's parent folders become data archive members using the default username and groupname. The permissions for these files and folders are the default file and folder mode respectively.</p>
<p>The files in the <tt>/etc/hiapp</tt> folder are marked as config file and are read only for members of the application's group.</p></div>
<div class="section">
<h3><a name="Pom"></a>Pom</h3>
<div class="source"><pre class="prettyprint">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
        xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
        &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
        &lt;groupId&gt;be.hobbiton.app&lt;/groupId&gt;
        &lt;artifactId&gt;hiapp&lt;/artifactId&gt;
        &lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;
        &lt;packaging&gt;deb&lt;/packaging&gt;
        &lt;name&gt;Cloud hi server&lt;/name&gt;
        &lt;description&gt;Cloud hi server - Non Secure Implementation&lt;/description&gt;

        &lt;developers&gt;
                &lt;developer&gt;
                        &lt;name&gt;Sam&lt;/name&gt;
                        &lt;email&gt;sam@hobbiton.be&lt;/email&gt;
                &lt;/developer&gt;
        &lt;/developers&gt;
...</pre></div>
<p>The use of <b>deb</b> as the packaging type is significant.</p>
<div class="source"><pre class="prettyprint">...
        &lt;dependencies&gt;
                &lt;dependency&gt;
                        &lt;groupId&gt;be.hobbiton.app&lt;/groupId&gt;
                        &lt;artifactId&gt;hiapp-web&lt;/artifactId&gt;
                        &lt;type&gt;jar&lt;/type&gt;
                        &lt;version&gt;${project.version}&lt;/version&gt;
                &lt;/dependency&gt;
        &lt;/dependencies&gt;
...</pre></div>
<p>If we want to package an artifact we have to declare it as a dependency, <b>hiapp-web</b> is our Spring Boot web app.</p>
<div class="source"><pre class="prettyprint">...
        &lt;build&gt;
                &lt;plugins&gt;
                        &lt;plugin&gt;
                                &lt;groupId&gt;be.hobbiton.maven&lt;/groupId&gt;
                                &lt;artifactId&gt;linux-packaging-maven-plugin&lt;/artifactId&gt;
                                &lt;extensions&gt;true&lt;/extensions&gt;
...</pre></div>
<p><b>Extensions</b> should be enabled for the plugin to kick in. Without it, the <b>deb</b> type lifecycle would not be picked up by maven.</p>
<div class="source"><pre class="prettyprint">...
                                &lt;configuration&gt;
                                        &lt;artifacts&gt;
                                                &lt;artifact&gt;
                                                        &lt;groupId&gt;be.hobbiton.app&lt;/groupId&gt;
                                                        &lt;artifactId&gt;hiapp-web&lt;/artifactId&gt;
                                                        &lt;destination&gt;/opt/hiapp/hiapp.jar&lt;/destination&gt;
                                                &lt;/artifact&gt;
                                        &lt;/artifacts&gt;
...</pre></div>
<p>The <b>hiapp-web</b> artifact is installed in the <tt>/opt/hiapp/</tt> folder with hiapp.jar as it's file name.</p>
<div class="source"><pre class="prettyprint">...
                                        &lt;folders&gt;
                                                &lt;folder&gt;
                                                        &lt;path&gt;/var/log/hiapp&lt;/path&gt;
                                                        &lt;username&gt;hiapp&lt;/username&gt;
                                                &lt;/folder&gt;
                                        &lt;/folders&gt;
...</pre></div>
<p>The <b>/var/log/hiapp</b> folder owned by the <b>hiapp</b> user must be created by the package.</p>
<div class="source"><pre class="prettyprint">...
                                        &lt;attributes&gt;
                                                &lt;attribute&gt;
                                                        &lt;expression&gt;/etc/hiapp/*&lt;/expression&gt;
                                                        &lt;groupname&gt;hiapp&lt;/groupname&gt;
                                                        &lt;mode&gt;0640&lt;/mode&gt;
                                                        &lt;config&gt;true&lt;/config&gt;
                                                &lt;/attribute&gt;
                                        &lt;/attributes&gt;
...</pre></div>
<p>The files in the <tt>/etc/hiapp</tt> folder are marked as config file and are read only for members of the application's group, the default user (root) has read-write permissions.</p>
<div class="source"><pre class="prettyprint">...
                                &lt;/configuration&gt;
                        &lt;/plugin&gt;
                &lt;/plugins&gt;
        &lt;/build&gt;
&lt;/project&gt;</pre></div></div>
<div class="section">
<h3><a name="Result"></a>Result</h3>
<p>The resulting Debian package:</p>
<div class="source"><pre class="prettyprint">$ mvn be.hobbiton.maven:linux-packaging-maven-plugin:info -Dfile=target/hiapp-1.0.0-SNAPSHOT.deb
Package: hiapp
Version: 1.0.0-20151019011349
Architecture: all
Maintainer: Sam &lt;sam@hobbiton.be&gt;
Installed-Size: 380
Description: Cloud hi server
 Cloud hi server - Non Secure Implementation

Control files:
conffiles
control
preinst

Configuration files:
/etc/hiapp/hiapp.properties

Data files:
drwxr-xr-x     root/root         0 ./etc/
drwxr-xr-x     root/root         0 ./etc/hiapp/
-rw-r-----     root/hiapp       52 ./etc/hiapp/hiapp.properties
drwxr-xr-x     root/root         0 ./lib
drwxr-xr-x     root/root         0 ./lib/systemd
drwxr-xr-x     root/root         0 ./lib/systemd/system
-rw-r--r--     root/root       421 ./lib/systemd/system/hiapp.service
drwxr-xr-x     root/root         0 ./opt/
drwxr-xr-x     root/root         0 ./opt/hiapp/
-rw-r--r--     root/root    378787 ./opt/hiapp/hiapp.jar
drwxr-xr-x     root/root         0 ./var/
drwxr-xr-x     root/root         0 ./var/log/
drwxr-xr-x    hiapp/root         0 ./var/log/hiapp/</pre></div>
<p>The fields in the package are derived from the standard pom field where sensible.</p>
<p>The usernames, groups and permissions are all defaults except for the username of the owner of the <tt>/var/log/hiapp</tt> folder and the group name of the <tt>/etc/hiapp/hiapp.properties</tt> file.</p></div>
<div class="section">
<h3><a name="preinst"></a>preinst</h3>
<p>The <b>preinst</b> Debain maintainer script that creates the <b>hiapp</b> user contains:</p>
<div class="source"><pre class="prettyprint">#!/bin/sh
set -e

USER='hiapp'
HOMEDIR='/opt/hiapp'

case &quot;$1&quot; in
  install)

  # Add user if it doesn't already exists
  if ! getent passwd ${USER} &gt;/dev/null 2&gt;&amp;1
  then
    useradd --system --user-group --home-dir ${HOMEDIR} --shell /sbin/nologin ${USER}
  fi
esac

exit 0</pre></div></div>
<div class="section">
<h3><a name="systemd_service_file"></a>systemd service file</h3>
<p>The systemd service file example:</p>
<div class="source"><pre class="prettyprint">[Unit]
Description=Say Hi server

[Service]
ExecStart=java -jar /opt/hiapp/hiapp.jar
User=hiapp
TimeoutSec=120
KillMode=process
Restart=on-failure

[Install]
WantedBy=multi-user.target</pre></div></div></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2015&#x2013;2019
<a href="http://www.hobbiton.be">hobbiton bvba</a>.
All rights reserved.</p>
        </div>
        </div>
    </footer>
    </body>
</html>
